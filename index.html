<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Viewer</title>
    <!-- Firebase v10 Modular SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';
        
        // Your Firebase Config
        window.firebaseConfig = {
            apiKey: "AIzaSyCj0PffLL4gjLEcndJwD-guceGVdQCEh_w",
            authDomain: "wefollow-789a9.firebaseapp.com",
            databaseURL: "https://wefollow-789a9-default-rtdb.firebaseio.com",
            projectId: "wefollow-789a9",
            storageBucket: "wefollow-789a9.firebasestorage.app",
            messagingSenderId: "975020938711",
            appId: "1:975020938711:web:d89224ad5fa2eb0fdf2792",
            measurementId: "G-F0Q00Z1RSP"
        };
        
        // Initialize Firebase globally
        window.app = initializeApp(window.firebaseConfig);
        window.db = getFirestore(window.app);
        window.storage = getStorage(window.app);
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .admin-panel { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 30px; display: none; }
        .admin-panel.show { display: block; }
        input, button { padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .password-input { width: 250px; }
        .file-input { width: 100%; }
        .documents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .document-card { border: 1px solid #ddd; border-radius: 10px; padding: 20px; text-align: center; }
        .document-card img { max-width: 100%; max-height: 200px; border-radius: 5px; object-fit: cover; }
        .document-card object { width: 100%; height: 400px; border-radius: 5px; }
        .document-title { font-weight: bold; margin: 10px 0; color: #333; }
        .upload-status { margin-top: 10px; padding: 10px; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .admin-toggle { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 10px 15px; border-radius: 25px; cursor: pointer; z-index: 1000; font-weight: bold; }
        .admin-toggle:hover { background: #218838; }
        .loading { text-align: center; padding: 40px; font-style: italic; color: #666; }
    </style>
</head>
<body>
    <!-- Admin Toggle Button -->
    <div class="admin-toggle" onclick="toggleAdminPanel()">Admin Panel</div>

    <!-- Admin Upload Panel -->
    <div class="admin-panel" id="adminPanel">
        <h2>üîê Admin Upload</h2>
        <input type="password" id="adminPassword" class="password-input" placeholder="Enter password: aariz@2012">
        <br>
        <input type="file" id="fileInput" class="file-input" accept="image/*,.pdf">
        <br>
        <input type="text" id="fileTitle" placeholder="Document Title (optional)">
        <br>
        <button id="uploadBtn" onclick="uploadFile()" disabled>Upload Document</button>
        <div id="uploadStatus" class="upload-status"></div>
    </div>

    <!-- Documents Display -->
    <h1>üìÑ Documents</h1>
    <div id="documentsGrid" class="documents-grid">
        <div class="loading">Loading documents...</div>
    </div>

    <script type="module">
        import { collection, addDoc, query, orderBy, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        import { ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

        const ADMIN_PASSWORD = 'aariz@2012';
        const adminPanel = document.getElementById('adminPanel');
        const passwordInput = document.getElementById('adminPassword');
        const fileInput = document.getElementById('fileInput');
        const fileTitleInput = document.getElementById('fileTitle');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const documentsGrid = document.getElementById('documentsGrid');

        let isPasswordCorrect = false;

        // Toggle Admin Panel
        window.toggleAdminPanel = function() {
            adminPanel.classList.toggle('show');
            if (adminPanel.classList.contains('show')) {
                passwordInput.focus();
            }
        }

        // Check Password
        function checkPassword() {
            if (passwordInput.value === ADMIN_PASSWORD) {
                isPasswordCorrect = true;
                showStatus('‚úÖ Password correct! You can now upload files.', 'success');
                passwordInput.style.borderColor = '#28a745';
                uploadBtn.disabled = false;
                return true;
            } else {
                isPasswordCorrect = false;
                showStatus('‚ùå Incorrect password!', 'error');
                passwordInput.style.borderColor = '#dc3545';
                uploadBtn.disabled = true;
                return false;
            }
        }

        // Show Status Message
        function showStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = `upload-status ${type}`;
            uploadStatus.style.display = 'block';
            setTimeout(() => {
                uploadStatus.style.display = 'none';
            }, 4000);
        }

        // Upload File
        window.uploadFile = async function() {
            if (!isPasswordCorrect) {
                checkPassword();
                return;
            }

            const file = fileInput.files[0];
            if (!file) {
                showStatus('Please select a file first!', 'error');
                return;
            }

            if (file.size > 20 * 1024 * 1024) { // 20MB limit
                showStatus('File too large! Max 20MB', 'error');
                return;
            }

            const title = fileTitleInput.value || file.name;
            const fileExt = file.name.split('.').pop().toLowerCase();
            const isImage = ['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp'].includes(fileExt);
            const timestamp = Date.now();

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            try {
                showStatus('üì§ Uploading file...', 'success');
                
                // Upload to Storage
                const storageReference = storageRef(window.storage, `documents/${timestamp}_${file.name}`);
                await uploadBytes(storageReference, file);
                const downloadURL = await getDownloadURL(storageReference);

                // Save metadata to Firestore
                await addDoc(collection(window.db, 'documents'), {
                    title: title,
                    url: downloadURL,
                    type: isImage ? 'image' : 'pdf',
                    filename: file.name,
                    uploadedAt: serverTimestamp(),
                    size: file.size,
                    timestamp: timestamp
                });

                showStatus('üéâ File uploaded successfully!', 'success');
                fileInput.value = '';
                fileTitleInput.value = '';
                loadDocuments();

            } catch (error) {
                console.error('Upload failed:', error);
                showStatus('‚ùå Upload failed: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Document';
            }
        }

        // Load and Display Documents
        window.loadDocuments = async function() {
            try {
                documentsGrid.innerHTML = '<div class="loading">Loading documents...</div>';
                
                const q = query(collection(window.db, 'documents'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    documentsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">No documents uploaded yet.</div>';
                    return;
                }

                documentsGrid.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const card = createDocumentCard(data);
                    documentsGrid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading documents:', error);
                documentsGrid.innerHTML = '<div class="loading" style="color: #dc3545;">Error loading documents. Please refresh.</div>';
            }
        }

        // Create Document Card
        function createDocumentCard(data) {
            const card = document.createElement('div');
            card.className = 'document-card';

            card.innerHTML = `
                <div class="document-title">${data.title || data.filename}</div>
                ${data.type === 'image' ? 
                    `<img src="${data.url}" alt="${data.title}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><p style="display:none;">Image failed to load</p>` :
                    `<object data="${data.url}#view=FitH&scrollbar=0" type="application/pdf" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                        <p style="display:none;"><a href="${data.url}" target="_blank">üì• Download PDF</a></p>
                    </object>`
                }
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    ${formatFileSize(data.size)} ‚Ä¢ ${data.filename}
                </div>
            `;

            return card;
        }

        // Format File Size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Event Listeners
        passwordInput.addEventListener('input', checkPassword);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') uploadFile();
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files[0] && !isPasswordCorrect) {
                checkPassword();
            }
        });

        // Load documents when Firebase is ready
        window.addEventListener('load', () => {
            setTimeout(loadDocuments, 1000);
        });

        // Auto-refresh every 30 seconds
        setInterval(loadDocuments, 30000);
    </script>
</body>
</html>
